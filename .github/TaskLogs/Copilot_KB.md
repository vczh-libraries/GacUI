# !!!KNOWLEDGE BASE!!!

# DOCUMENT REQUEST

## TOPIC

List all things that one should do if he want to add a new control to GacUI. It may includes:
- Adding a new control template definition and control template name
- Define and register a new control template implementation
- A sample code for a new control
- Register reflection for the control
- Make the control visible to GacUI XML Compiler
- Any other thing you find that is necessary

Existing controls are developed following the same pattern, you should carefully read them before making any guidance.

### Insight

Based on my analysis of `GuiButton` and `GuiSelectableButton`, here is the comprehensive process to add a new control to GacUI:

#### 1. Control Class Definition (in `Source/Controls/*.h`)

The control class must:
- Inherit from `GuiControl` (or another control base class) and `Description<YourControl>`
- Use `GUI_SPECIFY_CONTROL_TEMPLATE_TYPE(TemplateName, BaseControlType)` macro to specify the template type
- Declare member variables for control state
- Override lifecycle methods from `GuiControl`:
  - `BeforeControlTemplateUninstalled_()` - cleanup before template removal
  - `AfterControlTemplateInstalled_(bool initialize)` - setup after template installation
  - `OnParentLineChanged()` - handle parent hierarchy changes
  - `OnActiveAlt()` - handle ALT key activation
  - `IsTabAvailable()` - control TAB navigation availability
- Attach event handlers in constructor to `boundsComposition->GetEventReceiver()` for mouse/keyboard events
- Define public events using `compositions::GuiNotifyEvent`
- Define properties with getters/setters
- Take a `theme::ThemeName` parameter in constructor and pass it to base class

Example pattern from `GuiButton`:
- Constructor: `GuiButton(theme::ThemeName themeName) : GuiControl(themeName)`
- Template macro: `GUI_SPECIFY_CONTROL_TEMPLATE_TYPE(ButtonTemplate, GuiControl)`
- Events: `BeforeClicked`, `Clicked`, `AfterClicked`
- State management: `UpdateControlState()` method to sync with template

#### 2. Control Implementation (in `Source/Controls/*.cpp`)

Implement:
- Constructor: Initialize state, set up event handlers on `boundsComposition`
- Destructor: Cleanup (usually minimal, automatic cleanup happens)
- `BeforeControlTemplateUninstalled_()`: Clear template-specific state
- `AfterControlTemplateInstalled_(bool initialize)`: Call template methods like `TypedControlTemplateObject(true)->SetState(controlState)`
- Event handlers: Mouse events (leftButtonDown, leftButtonUp, mouseEnter, mouseLeave), keyboard events (keyDown, keyUp)
- Property getters/setters
- Call `TypedControlTemplateObject(true)` to access the typed template object

#### 3. Control Template Definition (in `Source/Controls/Templates/GuiControlTemplates.h`)

Add three entries:

a) **Template declaration in `GUI_CONTROL_TEMPLATE_DECL` macro**:
```cpp
F(GuiYourTemplate, GuiBaseTemplate)
```

b) **Template properties macro definition**:
```cpp
#define GuiYourTemplate_PROPERTIES(F)\
    F(GuiYourTemplate, PropertyType, PropertyName, DefaultValue)
```

c) **Forward declaration and class declaration**:
The macros `GUI_TEMPLATE_CLASS_FORWARD_DECL` and `GUI_TEMPLATE_CLASS_DECL` are applied to generate these automatically.

Properties are defined using the `F` macro with: template class name, property type, property name, default value.

#### 4. Control Template Implementation (in `Source/Controls/Templates/GuiControlTemplates.cpp`)

The template implementation is auto-generated by:
```cpp
GUI_CONTROL_TEMPLATE_DECL(GUI_TEMPLATE_CLASS_IMPL)
```

This macro expands to create:
- Property getter/setter implementations with change events
- Constructor that initializes event handlers
- Destructor that calls `FinalizeAggregation()`

#### 5. Theme Name Registration (in `Source/Application/Controls/GuiThemeManager.h`)

Add the control to `GUI_CONTROL_TEMPLATE_TYPES` macro:
```cpp
#define GUI_CONTROL_TEMPLATE_TYPES(F) \
    ... existing entries ...\
    F(YourTemplate, YourControl)
```

This generates the corresponding `theme::ThemeName::YourControl` enum value.

#### 6. Reflection Registration (in `Source/Reflection/TypeDescriptors/`)

Three steps are required:

a) **Add to type list** (in `GuiReflectionPlugin.h`):
Add to `GUIREFLECTIONCONTROLS_CLASS_TYPELIST` macro:
```cpp
F(presentation::controls::GuiYourControl)
```

b) **Register control class** (in `GuiReflectionControls.cpp`):
```cpp
BEGIN_CLASS_MEMBER(GuiYourControl)
    CLASS_MEMBER_BASE(GuiBaseControl)
    CONTROL_CONSTRUCTOR_CONTROLT_TEMPLATE(GuiYourControl)
    
    CLASS_MEMBER_GUIEVENT(EventName)
    CLASS_MEMBER_PROPERTY_FAST(PropertyName)
    CLASS_MEMBER_PROPERTY_GUIEVENT_FAST(PropertyWithEvent)
    CLASS_MEMBER_METHOD(MethodName, {L"param1" _ L"param2"})
END_CLASS_MEMBER(GuiYourControl)
```

c) **Register template class** (in `GuiReflectionTemplates.cpp`):
Templates are auto-registered via the `GUI_CONTROL_TEMPLATE` macro expansion which applies to all templates declared in `GUI_CONTROL_TEMPLATE_DECL`.

#### 7. Instance Loader Registration (in `Source/Compiler/InstanceLoaders/GuiInstanceLoader_Plugin.cpp`)

Add to the loader registration in `IGuiPlugin::Load()`:

For a normal control:
```cpp
ADD_TEMPLATE_CONTROL(GuiYourControl, YourControl);
```

For a virtual control (one that uses another control's implementation but different theme):
```cpp
ADD_VIRTUAL_CONTROL(VirtualName, GuiActualControl, ThemeName);
```

This uses the `GuiTemplateControlInstanceLoader<T>` template class to register the control with the instance loader manager.

#### 8. Control Header File Inclusion

Add includes to:
- `Source/Controls/IncludeForward.h` - forward declaration
- `Source/Controls/IncludeAll.h` - full header inclusion

#### 9. Sample Pattern from GuiButton

Key patterns observed:
- State machine pattern: `controlState` variable tracks button visual state (Normal, Active, Pressed)
- Event chaining: `BeforeClicked` → `Clicked` → `AfterClicked`
- Mouse tracking: Separate flags for `mousePressingDirect`, `mousePressingIndirect`, `mouseHoving`
- Keyboard support: SPACE and ENTER keys trigger click
- Focus integration: `SetFocusableComposition(boundsComposition)` and `autoFocus` property
- Template communication: Call template setters like `SetState()`, `SetSelected()` in `AfterControlTemplateInstalled_`

#### 10. Additional Files to Update

- Add control source files to the Visual Studio project (`.vcxproj` file in `Source/GacUICompiler`)
- Add files to solution filters (`.vcxproj.filters` file)
- Ensure the control appears in generated release files (automatic through build process)

#### 11. Template Property Access Pattern

Controls access template properties via:
- `TypedControlTemplateObject(true)` - gets the typed template with existence check
- `TypedControlTemplateObject(false)` - gets the typed template without check
- Template properties have auto-generated `Get/Set` methods and `Changed` events

#### 12. Control Template Macro System

The macro system provides:
- `GUI_TEMPLATE_CLASS_DECL`: Generates class declaration with properties
- `GUI_TEMPLATE_CLASS_IMPL`: Generates implementation (constructor, destructor, property accessors)
- `GUI_SPECIFY_CONTROL_TEMPLATE_TYPE`: Links control to its template type with automatic casting
- Property macros: Generate private field, getter, setter, and change event

#### Summary of Files to Modify

1. `Source/Controls/Gui*Controls.h` - Control class declaration
2. `Source/Controls/Gui*Controls.cpp` - Control implementation  
3. `Source/Controls/Templates/GuiControlTemplates.h` - Template declaration and properties
4. `Source/Controls/Templates/GuiControlTemplates.cpp` - Template implementation (usually just macro)
5. `Source/Application/Controls/GuiThemeManager.h` - Theme name registration
6. `Source/Reflection/TypeDescriptors/GuiReflectionPlugin.h` - Add to type list
7. `Source/Reflection/TypeDescriptors/GuiReflectionControls.cpp` - Control reflection
8. `Source/Reflection/TypeDescriptors/GuiReflectionTemplates.cpp` - Template reflection (automatic)
9. `Source/Compiler/InstanceLoaders/GuiInstanceLoader_Plugin.cpp` - XML loader registration
10. `Source/Controls/IncludeForward.h` and `IncludeAll.h` - Header organization
11. Project files - Visual Studio project and filters